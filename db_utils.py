faculties = {
    'Кібербезпека': ['КБ-001', 'КБ-002'],
    'Системний аналіз': ['СА-001', 'СА-002']
}

schedule = {
    'КБ-001': {
       'MONDAY': {
            '1': 'Математический анализ (212)',
            '2': 'Основы программирования (308)',
            '3': 'Теория вероятности (104)',
            '4': 'Физическая культура'
        },
        'TUESDAY': {
            '1': 'Право (104А)',
            '2': 'Основы программирования (308)',
            '3': 'Математический анализ (212)',
            '4': 'Психология (101)'
        },
        'WEDNESDAY': {
            '1': 'Экономика (304)',
            '2': 'Политология (101)',
            '3': 'Теория вероятности (104)',
            '4': 'Информационная безопасность (104)'
        },
        'THURSDAY': {
            '1': 'Математический анализ (212)',
            '2': 'Политология (101)',
            '3': 'Теория вероятности (104)',
            '4': 'Физическая культура'
        },
        'FRIDAY': {
            '1': 'Экономика (304)',
            '2': 'Основы программирования (308)',
            '3': 'Математический анализ (212)',
            '4': 'Информационная безопасность (104)'
        },
        'SATURDAY': {
            '1': 'Кураторский час (308)',
            '2': 'Основы программирования (308)',
            '3': 'Информационная безопасность (104)',
            '4': 'Экономика (304)'
        }
    },
    'КБ-002': {
        'MONDAY': {
            '1': 'Математический анализ (212)',
            '2': 'Основы программирования (308)',
            '3': 'Теория вероятности (104)',
            '4': 'Физическая культура'
        },
        'TUESDAY': {
            '1': 'Право (104А)',
            '2': 'Основы программирования (308)',
            '3': 'Математический анализ (212)',
            '4': 'Психология (101)'
        },
        'WEDNESDAY': {
            '1': 'Экономика (304)',
            '2': 'Политология (101)',
            '3': 'Теория вероятности (104)',
            '4': 'Информационная безопасность (104)'
        },
        'THURSDAY': {
            '1': 'Математический анализ (212)',
            '2': 'Политология (101)',
            '3': 'Теория вероятности (104)',
            '4': 'Физическая культура'
        },
        'FRIDAY': {
            '1': 'Экономика (304)',
            '2': 'Основы программирования (308)',
            '3': 'Математический анализ (212)',
            '4': 'Информационная безопасность (104)'
        },
        'SATURDAY': {
            '1': 'Кураторский час (308)',
            '2': 'Основы программирования (308)',
            '3': 'Информационная безопасность (104)',
            '4': 'Экономика (304)'
        }
    },
    'СА-001': {
        'MONDAY': {
            '1': 'Математический анализ (212)',
            '2': 'Основы программирования (308)',
            '3': 'Теория вероятности (104)',
            '4': 'Физическая культура'
        },
        'TUESDAY': {
            '1': 'Право (104А)',
            '2': 'Основы программирования (308)',
            '3': 'Математический анализ (212)',
            '4': 'Психология (101)'
        },
        'WEDNESDAY': {
            '1': 'Экономика (304)',
            '2': 'Политология (101)',
            '3': 'Теория вероятности (104)',
            '4': 'Информационная безопасность (104)'
        },
        'THURSDAY': {
            '1': 'Математический анализ (212)',
            '2': 'Политология (101)',
            '3': 'Теория вероятности (104)',
            '4': 'Физическая культура'
        },
        'FRIDAY': {
            '1': 'Экономика (304)',
            '2': 'Основы программирования (308)',
            '3': 'Математический анализ (212)',
            '4': 'Информационная безопасность (104)'
        },
        'SATURDAY': {
            '1': 'Кураторский час (308)',
            '2': 'Основы программирования (308)',
            '3': 'Информационная безопасность (104)',
            '4': 'Экономика (304)'
        }
    },
    'СА-002': {
        'MONDAY': {
            '1': 'Математический анализ (212)',
            '2': 'Основы программирования (308)',
            '3': 'Теория вероятности (104)',
            '4': 'Физическая культура'
        },
        'TUESDAY': {
            '1': 'Право (104А)',
            '2': 'Основы программирования (308)',
            '3': 'Математический анализ (212)',
            '4': 'Психология (101)'
        },
        'WEDNESDAY': {
            '1': 'Экономика (304)',
            '2': 'Политология (101)',
            '3': 'Теория вероятности (104)',
            '4': 'Информационная безопасность (104)'
        },
        'THURSDAY': {
            '1': 'Математический анализ (212)',
            '2': 'Политология (101)',
            '3': 'Теория вероятности (104)',
            '4': 'Физическая культура'
        },
        'FRIDAY': {
            '1': 'Экономика (304)',
            '2': 'Основы программирования (308)',
            '3': 'Математический анализ (212)',
            '4': 'Информационная безопасность (104)'
        },
        'SATURDAY': {
            '1': 'Кураторский час (308)',
            '2': 'Основы программирования (308)',
            '3': 'Информационная безопасность (104)',
            '4': 'Экономика (304)'
        }
    }
}

change_list = {
    'КБ-001': [],
    'КБ-002': [],
    'СА-001': [],
    'СА-002': []
}

assigns_users = {
    'КБ-001': [],
    'КБ-002': [],
    'СА-001': [],
    'СА-002': []
}

schedule_group_template = {
    'MONDAY': {
        '1': '',
        '2': '',
        '3': '',
        '4': ''
    },
    'TUESDAY': {
        '1': '',
        '2': '',
        '3': '',
        '4': ''
    },
    'WEDNESDAY': {
        '1': '',
        '2': '',
        '3': '',
        '4': ''
    },
    'THURSDAY': {
        '1': '',
        '2': '',
        '3': '',
        '4': ''
    },
    'FRIDAY': {
        '1': '',
        '2': '',
        '3': '',
        '4': ''
    },
    'SATURDAY': {
        '1': '',
        '2': '',
        '3': '',
        '4': ''
    }
}

day_names = ['MONDAY', 'TUESDAY', 'WEDNESDAY', 'THURSDAY', 'FRIDAY', 'SATURDAY']
lesson_nums = ['1', '2', '3', '4']
lessons_mock = ['Дискрена математика', 'Статистичні методи дослідження', 'Моделювання складних систем',
                'Вища математика', 'Програмування', 'Іноземна мова', 'Основи психології', "Комп'ютерні мережі",
                'Теорія ймовірності', 'Математична статистика', 'Теорія ігор', 'Інформаційна логістика',
                'Економічний ризик та методи його моделювання']


def createFaculty(faculty_name):
    faculty_name = faculty_name.strip()
    if not isFacultyExist(faculty_name):
        faculties[faculty_name] = []
        log("Faculty " + faculty_name + " created successful")
        return
    else :
        log("Can not create faculty: " + faculty_name)

def isFacultyExist(faculty_name):
    for stored_faculty in faculties:
        if stored_faculty == faculty_name:
            return True
    return False

def getAllFaculties():
    return faculties.keys()

def getAllGroups():
    return schedule.keys()

def getAllGroupsOfFaculty(faculty_name):
    return faculties[faculty_name]

def createGroup(faculty_name, group_name):
    faculty_name = faculty_name.strip()
    group_name = group_name.strip()

    createFaculty(faculty_name)
    
    if not isGroupExists(group_name):
        faculties[faculty_name].append(group_name)
        schedule[group_name] = schedule_group_template
        change_list[group_name] = []
        assigns_users[group_name] = []
        log("Group " + group_name + " created successful")
        return
    else:
        log("Can not create group: " + group_name)

def isGroupExists(group_name):
    for faculty in faculties:
        for group in faculties[faculty]:
            if group == group_name:
                return True
    return False

def updateSchedule(group_name, day_name, lesson_num, new_lesson_name):
    if isGroupExists(group_name) and (day_name in day_names) and (lesson_num in lesson_nums):
        if schedule[group_name][day_name][lesson_num] == str(new_lesson_name):
            log("Lesson {} exists for {} {} {}".format(str(new_lesson_name), group_name, day_name, lesson_num))
            return
        schedule[group_name][day_name][lesson_num] = str(new_lesson_name)
        log("Schedule for " + group_name + " " + day_name + " " + lesson_num + " UPDATED")
        if day_name not in change_list[group_name]:
            change_list[group_name].append(day_name)
            log(group_name + " " + day_name + " - add to group update list")
    else:
        log("Can not update schedule {} {} {} {}".format(group_name, day_name, lesson_num, new_lesson_name))

def subscribeUser(group_name, user_callback_id):
    group_name = group_name.strip()
    if isGroupExists(group_name):
        if isUserExists(user_callback_id):
            unsubscribeUser(user_callback_id)
        assigns_users[group_name].append(user_callback_id)
        log("User {} subscribe to {} group".format(user_callback_id, group_name))

def unsubscribeUser(user_callback_id):
    for group in assigns_users.keys():
        if isUserExistsInGroup(group, user_callback_id):
            assigns_users[group].remove(user_callback_id)
            log("User {} unsubscribe from group {}".format(user_callback_id, group))
    return

def isUserExists(user_callback_id):
    for group in assigns_users.keys():
        if isUserExistsInGroup(group, user_callback_id):
            return True
    return False


def isUserExistsInGroup(group_name, user_callback_id):
    if isGroupExists(group_name):
        if user_callback_id in assigns_users[group_name]:
            return True
    return False

def getPushList():
    # Return dict {user: [list of update data]}
    data = {}
    for group in change_list.keys():
        if len(change_list[group]) > 0:
            for user in assigns_users[group]:
                for day in change_list[group]:
                    if not user in data.keys():
                        data[user] = {}
                    if not day in data[user].keys():
                        data[user][day] = {}
                    data[user][day] = schedule[group][day]
    return data


def cleanChangeList():
    for group in change_list.keys():
        change_list[group] = []
    log("Change list cleaned")

def getGroupByUser(user_callback_id):
    for group in assigns_users.keys():
        if user_callback_id in assigns_users[group]:
            return group
    return 'Unknown'

def random_update():
    import random
    for group in schedule.keys():
        updateSchedule( group,
                        random.choice(day_names),
                        random.choice(lesson_nums),
                        random.choice(lessons_mock) + " (" + random.choice(range(560) + ")"))

def get_lessons_by_group_for_day(group, day):
    if isGroupExists(group) and (day in day_names):
        lessons = schedule[group][day]
        return lessons
    else:
        log("No data for {} {}".format(group, day))
        return None


def log(message):
    print('[DB_UTILS] ' + message)

if __name__ == "__main__":
    # Test
    faculty_name = "test_faculty"
    group_name = "test_group"
    group_name_2 = "test_group_2"
    user_id_1 = "555"
    user_id_2 = "444"
    lesson_name = "test_lesson"

    print("--- Create groups ---")
    createGroup(faculty_name, group_name)
    createGroup(faculty_name, group_name_2)
    print("\n")

    print("--- Subscr and update ---")
    subscribeUser(group_name, user_id_1)
    updateSchedule(group_name, day_names[0], lesson_nums[0], lesson_name)
    print(str(getPushList()) + "\n")

    print("--- Unsubscr and get changes ---")
    unsubscribeUser(user_id_1)
    print(str(getPushList()) + "\n")

    print("--- More than one user ---")
    subscribeUser(group_name, user_id_1)
    subscribeUser(group_name_2, user_id_2)
    updateSchedule(group_name, day_names[0], lesson_nums[2], lesson_name)
    updateSchedule(group_name, day_names[1], lesson_nums[1], lesson_name)
    updateSchedule(group_name_2, day_names[4], lesson_nums[3], lesson_name)
    print(str(getPushList()) + "\n")

    print("--- Clean changes ---")
    cleanChangeList()
    print(str(getPushList()) + "\n")

    print("--- 3 random updates ---")
    random_update()
    random_update()
    random_update()
    print(str(getPushList()) + "\n")
    cleanChangeList()


    print("--- Group by User ---")
    print(str(getGroupByUser(user_id_1))+ "\n")
